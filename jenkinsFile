pipeline{
agent any 
environment{
notifyEmail= "kajal.miglani@nagarro.com"
}
tools{
maven '3.9.4'
}
triggers {
cron('0 08 * * *')
}
stages
{

stage ('code build'){
steps{
bat "mvn clean"
}
}
stage ('run test'){
steps{
bat "mvn test"
}
}
   stage('SonarQube Analysis') {
            steps {
             mvn sonar:sonar
            }
        }
}

post
{

success{
   script {
                // Check SonarQube Quality Gate status
                def qualityGateStatus = waitForQualityGate()
                if (qualityGateStatus != 'OK') {
                    error("SonarQube Quality Gate failed")
                }
			
rtMavenDeployer(
id:'deployer',
serverId: 'nagpJfrog@artifactory',
releaseRepo: 'RepoTest',
snapshotRepo: 'RepoTest'
)
rtMavenRun(
pom: 'pom.xml',
goals: 'clean install',
deployerId: 'deployer'
)
rtPublishBuildInfo(
serverId:'nagpJfrog@artifactory',
)

}

}
}

failure{
   echo 'Build or test failures detected'
            currentBuild.result = 'FAILURE'}


def waitForQualityGate() {
    timeout(time: 1, unit: 'HOURS') {
        def qg = waitForQualityGate() // Requires the SonarQube Scanner for Jenkins plugin
        return qg.status
    }
}
}


