pipeline{
agent any 
environment{
notifyEmail= "kajal.miglani@nagarro.com"
}
tools{
maven '3.9.4'
}
triggers {
cron('0 08 * * *')
}
stages
{

stage ('code build'){
steps{
bat "mvn clean"
}
}
stage ('run test'){
steps{
bat "mvn test"
}
}
   stage('SonarQube Analysis') {
            steps {
script{
WithSonarQubeEnv('Test_Sonar')
{
bat " echo 'Sonar validation'"
          bat "mvn sonar:sonar"
            }
        }
}}
}
post
{

success{
   script {
                def qualityGateStatus = waitForQualityGate()
                if (qualityGateStatus != 'OK') {
                    error("SonarQube Quality Gate failed")
                }
bat " echo 'Success block'"	
rtMavenDeployer(
id:'deployer',
serverId: 'nagpJfrog@artifactory',
releaseRepo: 'RepoTest',
snapshotRepo: 'RepoTest'
)
rtMavenRun(
pom: 'pom.xml',
goals: 'clean install',
deployerId: 'deployer'
)
rtPublishBuildInfo(
serverId:'nagpJfrog@artifactory',
)

}

}


failure{
bat " echo Sonar failure block"
   echo 'Build or test failures detected'
            error("Build or Test failure detected")
}
}
}

def waitForQualityGate() {
    timeout(time: 1, unit: 'HOURS') {
        def qg = waitForQualityGate() 
        return qg.status
    }
}



